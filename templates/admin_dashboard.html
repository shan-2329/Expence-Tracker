<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard â€“ JAGADHA ðŸ’— A to Z</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#f8f9fc; font-family:"Nunito",sans-serif; }

.dashboard-container{max-width:1820px;}

.dashboard-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}

.dashboard-title{
  font-size:2rem;
  font-weight:700;
  color:#d4af37;
}

/* ===== SUMMARY CARDS ===== */
.card-stats{
  border-radius:12px;
  padding:16px;
  transition:.2s;
}
.card-stats:hover{
  transform:translateY(-5px);
  box-shadow:0 0 18px rgba(0,0,0,.12);
}

.card-stats i{
  font-size:2.6rem;
  opacity:.25;
}

.stat-total{
  background:#ffe6f0;
  border-left:6px solid #ff5c8a;
}
.stat-confirmed{
  background:#e8f7ee;
  border-left:6px solid #28a745;
}
.stat-pending{
  background:#fff4cc;
  border-left:6px solid #ffc107;
}
.stat-rejected{
  background:#fdecea;
  border-left:6px solid #dc3545;
}

.card-stats h3{
  font-weight:700;
}

/* ===== FILTER / TABLE ===== */
.filter-section{
  background:#fff;
  padding:15px;
  border-radius:12px;
  box-shadow:0 2px 12px rgba(0,0,0,.05);
}

table thead{
  background:#fff7df;
  color:#8b6f00;
}

table tbody tr:hover{background:#fff9ea;}

.badge-pending{background:#ffcc00;color:#5a4500;padding:4px 10px;border-radius:6px;}
.badge-confirmed{background:#28a745;color:#fff;padding:4px 10px;border-radius:6px;}
.badge-rejected{background:#dc3545;color:#fff;padding:4px 10px;border-radius:6px;}

.action-btn{
  font-size:12px;
  border-radius:6px;
  padding:4px 10px;
  margin:2px;
}
</style>
</head>

<body>
<div class="container dashboard-container mt-4">

<!-- HEADER -->
<div class="dashboard-header">
  <div class="dashboard-title">ðŸ“Š JAGADHA ðŸ’— A to Z â€“ Admin Dashboard</div>
  <a href="/logout" class="btn btn-outline-danger btn-sm">ðŸšª Logout</a>
</div>

<!-- SUMMARY -->
<div class="row g-3" id="summaryCards"></div>

<!-- FILTER -->
<div class="filter-section mt-4">
  <div class="row g-3">
    <div class="col-md-4">
      <input id="searchInput" class="form-control" placeholder="Search by name, phone, location">
    </div>
    <div class="col-md-3">
      <select id="statusFilter" class="form-select">
        <option value="">All Status</option>
        <option>Pending</option>
        <option>Confirmed</option>
        <option>Rejected</option>
      </select>
    </div>
    <div class="col-md-3">
      <select id="serviceFilter" class="form-select">
        <option value="">All Services</option>
      </select>
    </div>
  </div>
</div>

<!-- TABLE -->
<div class="table-responsive mt-4">
<table class="table table-bordered align-middle">
<thead>
<tr>
<th>#</th><th>Received</th><th>Name</th><th>Phone</th><th>Email</th>
<th>Service</th><th>Event Date</th><th>Location</th>
<th>Extras</th><th>Notes</th><th>Status</th><th>Actions</th>
</tr>
</thead>
<tbody id="bookingTable"></tbody>
</table>
</div>

<!-- PAGINATION -->
<div class="d-flex justify-content-center mt-3">
  <button id="prevPage" class="btn btn-outline-secondary me-2">Previous</button>
  <span id="pageNumber" class="mt-2 fw-bold"></span>
  <button id="nextPage" class="btn btn-outline-secondary ms-2">Next</button>
</div>

<!-- CHARTS -->
<div class="row mt-5">
  <div class="col-md-6"><canvas id="statusChart"></canvas></div>
  <div class="col-md-6"><canvas id="serviceChart"></canvas></div>
</div>
<div class="row mt-4">
  <div class="col-md-12"><canvas id="monthlyChart"></canvas></div>
</div>

</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const bookingTable=document.getElementById("bookingTable");
const pageNumber=document.getElementById("pageNumber");
const searchInput=document.getElementById("searchInput");
const statusFilter=document.getElementById("statusFilter");
const serviceFilter=document.getElementById("serviceFilter");
const prevPage=document.getElementById("prevPage");
const nextPage=document.getElementById("nextPage");
const summaryCards=document.getElementById("summaryCards");

const statusChartEl=document.getElementById("statusChart");
const serviceChartEl=document.getElementById("serviceChart");
const monthlyChartEl=document.getElementById("monthlyChart");

let bookings=[],filtered=[],currentPage=1;
const perPage=10;
let c1,c2,c3;

async function loadData(){
  const res=await fetch("/api/bookings",{credentials:"include"});
  if(!res.ok){location.href="/login";return;}
  const d=await res.json();
  bookings=[...d.bookings];
  filtered=[...bookings];
  renderSummary(d);
  loadServices();
  renderTable();
  updateCharts();
}

function renderSummary(d){
  summaryCards.innerHTML=`
  <div class="col-md-3">
    <div class="card card-stats stat-total">
      <div class="d-flex justify-content-between align-items-center">
        <div><h6>Total</h6><h3 class="count" data-count="${d.total}">0</h3></div>
        <i class="bi bi-collection"></i>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card card-stats stat-confirmed">
      <div class="d-flex justify-content-between align-items-center">
        <div><h6>Confirmed</h6><h3 class="count" data-count="${d.confirmed}">0</h3></div>
        <i class="bi bi-check-circle-fill"></i>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card card-stats stat-pending">
      <div class="d-flex justify-content-between align-items-center">
        <div><h6>Pending</h6><h3 class="count" data-count="${d.pending}">0</h3></div>
        <i class="bi bi-hourglass-split"></i>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card card-stats stat-rejected">
      <div class="d-flex justify-content-between align-items-center">
        <div><h6>Rejected</h6><h3 class="count" data-count="${d.rejected}">0</h3></div>
        <i class="bi bi-x-circle-fill"></i>
      </div>
    </div>
  </div>`;
  animateCounts();
}

function animateCounts(){
  document.querySelectorAll(".count").forEach(el=>{
    const target=+el.dataset.count;
    let current=0;
    const step=Math.max(1,Math.floor(target/30));
    const timer=setInterval(()=>{
      current+=step;
      if(current>=target){
        el.textContent=target;
        clearInterval(timer);
      }else el.textContent=current;
    },30);
  });
}

function loadServices(){
  const s=[...new Set(bookings.map(b=>b.service||"Unknown"))];
  serviceFilter.innerHTML='<option value="">All Services</option>'+s.map(x=>`<option>${x}</option>`).join("");
}

function badge(s){
  return s==="Confirmed"?"badge-confirmed":s==="Rejected"?"badge-rejected":"badge-pending";
}

function renderTable(){
  if(!filtered.length){
    bookingTable.innerHTML='<tr><td colspan="12" class="text-center text-muted">No bookings found</td></tr>';
    return;
  }

  const start=(currentPage-1)*perPage;
  const page=filtered.slice(start,start+perPage);

  bookingTable.innerHTML=page.map((b,i)=>{
    let eventDate="-";
    if(b.event_date){
      eventDate=new Date(b.event_date).toLocaleDateString("en-US",{
        weekday:"long",day:"2-digit",month:"short",year:"numeric"
      });
    }
    return `
    <tr>
      <td>${start+i+1}</td>
      <td>${new Date(b.created_at).toLocaleString()}</td>
      <td>${b.name}</td>
      <td>${b.phone}</td>
      <td>${b.customer_email||"-"}</td>
      <td>${b.service||"-"}</td>
      <td>${eventDate}</td>
      <td>${b.location}</td>
      <td>${b.extras||"-"}</td>
      <td>${b.notes||"-"}</td>
      <td><span class="${badge(b.status)}">${b.status}</span></td>
      <td>
        ${b.status==="Pending"?`
        <button class="btn btn-success btn-sm action-btn" onclick="updateStatus(${b.id},'confirm')">Confirm</button>
        <button class="btn btn-warning btn-sm action-btn" onclick="updateStatus(${b.id},'reject')">Reject</button>`:""}
      </td>
    </tr>`;
  }).join("");

  pageNumber.innerText=`Page ${currentPage}`;
}

window.updateStatus=async(id,action)=>{
  if(!confirm("Are you sure?"))return;
  await fetch(`/${action}/${id}`,{credentials:"include"});
  loadData();
};

searchInput.onkeyup=applyFilters;
statusFilter.onchange=applyFilters;
serviceFilter.onchange=applyFilters;

function applyFilters(){
  const q=searchInput.value.toLowerCase();
  filtered=bookings.filter(b=>
    (!q||(b.name+b.phone+b.location).toLowerCase().includes(q)) &&
    (!statusFilter.value||b.status===statusFilter.value) &&
    (!serviceFilter.value||b.service===serviceFilter.value)
  );
  currentPage=1;
  renderTable();
  updateCharts();
}

function updateCharts(){ /* unchanged */ }

loadData();
setInterval(loadData,30000);
});
</script>

</body>
</html>
