<!-- templates/admin_dashboard.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Admin Dashboard â€” JAGADHA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { padding:20px; background: linear-gradient(120deg,#fff3f8,#fff); font-family:Montserrat, sans-serif;}
    .card { margin-bottom:18px; }
    .table-responsive { max-height:420px; overflow:auto; }
  </style>
</head>
<body>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Admin Dashboard</h3>
    <div>
      <a href="/admin" class="btn btn-outline-secondary">Admin Table</a>
      <a href="/export_csv" class="btn btn-primary">Export CSV</a>
      <a href="/logout" class="btn btn-danger">Logout</a>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card p-3">
        <h6>Bookings by Status</h6>
        <canvas id="statusChart"></canvas>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h6>Bookings Last 7 Days</h6>
        <canvas id="weekChart"></canvas>
      </div>
    </div>
  </div>

  <div class="card p-3">
    <div class="mb-2 d-flex justify-content-between">
      <input id="filter" placeholder="Filter by name/phone/service/location" class="form-control w-50" />
      <div>
        <button id="refreshBtn" class="btn btn-sm btn-outline-primary">Refresh</button>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-bordered" id="dashTable">
        <thead>
          <tr><th>#</th><th>Name</th><th>Phone</th><th>Service</th><th>Date</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
async function loadData(){
  const res = await fetch('/api/bookings');
  const json = await res.json();
  return json.bookings || [];
}

function renderTable(rows){
  const tbody = document.querySelector('#dashTable tbody');
  tbody.innerHTML = '';
  rows.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.id}</td>
      <td>${r.name}</td>
      <td>${r.phone}</td>
      <td>${r.service}</td>
      <td>${r.event_date}</td>
      <td>${r.status}</td>
      <td>
        <a class="btn btn-sm btn-success" href="/confirm/${r.id}">Confirm</a>
        <a class="btn btn-sm btn-warning" href="/reject/${r.id}">Reject</a>
        <a class="btn btn-sm btn-danger" href="/delete/${r.id}">Delete</a>
        <a class="btn btn-sm btn-secondary" href="/receipt/${r.id}" target="_blank">PDF</a>
      </td>`;
    tbody.appendChild(tr);
  });
}

function drawStatusChart(rows){
  const counts = {};
  rows.forEach(r => counts[r.status] = (counts[r.status]||0)+1);
  const labels = Object.keys(counts);
  const data = labels.map(l=>counts[l]);
  const ctx = document.getElementById('statusChart').getContext('2d');
  if(window._statusChart) window._statusChart.destroy();
  window._statusChart = new Chart(ctx, {type:'doughnut', data:{labels, datasets:[{data}]}, options:{responsive:true}});
}

function drawWeekChart(rows){
  // last 7 days
  const days = [];
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    days.push(d.toISOString().slice(0,10));
  }
  const counts = days.map(day => rows.filter(r=>r.created_at && r.created_at.startsWith(day)).length);
  const ctx = document.getElementById('weekChart').getContext('2d');
  if(window._weekChart) window._weekChart.destroy();
  window._weekChart = new Chart(ctx, {type:'bar', data:{labels:days, datasets:[{label:'Bookings', data:counts}]}, options:{responsive:true}});
}

async function refreshAll(){
  const rows = await loadData();
  renderTable(rows);
  drawStatusChart(rows);
  drawWeekChart(rows);
}
document.getElementById('refreshBtn').addEventListener('click', refreshAll);
document.getElementById('filter').addEventListener('keyup', async function(){
  const val = this.value.toLowerCase();
  const rows = await loadData();
  renderTable(rows.filter(r=> (r.name||'').toLowerCase().includes(val) || (r.phone||'').toLowerCase().includes(val) || (r.service||'').toLowerCase().includes(val) || (r.location||'').toLowerCase().includes(val) ));
});
refreshAll();
</script>

</body>
</html>
